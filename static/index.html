<!DOCTYPE html>
<html>
<head>
    <title>Chronic Reader Client</title>
    <link rel="manifest" href="manifest.json">
    <script src="/serviceworkerinstall.js"></script>
    <script>
        function getBookItem(book, fill=true) {
            //console.log(book)
            let item = document.createElement("li")
            item.style.width = '100%'
            item.style.overflow = 'hidden'

            let itemLink = document.createElement("a")
            itemLink.style.overflow = 'hidden'
            itemLink.style.position = 'relative'
            itemLink.href = "/read.html?book=" + book.id
            
            let imageEnclosure = document.createElement("span")
            imageEnclosure.style.overflow = 'hidden'
            imageEnclosure.style.position = "relative"
            imageEnclosure.style.display = 'block'
            imageEnclosure.style.height = (8/5*30) + 'vw'
            //imageEnclosure.style.textAlign = 'center'
            //imageEnclosure.style.border = '1px solid black'

            let image = document.createElement("img")
            if (book.cover == null) {
                image.src = createBookCover(book.title, 500, 800)
            } else {
                image.src = book.cover
            }
            image.onload = () => {
                //console.log("loaded image sizes " + image.width + " " + image.height)
                //console.log("container sizes " + image.parentElement.offsetWidth + " " + image.parentElement.offsetHeight)
                /*if (fill) {
                    if (image.width < image.parentElement.offsetWidth) {
                        // widen the image
                        let ratio = image.parentElement.offsetWidth / image.width
                        console.log("ratio width: " + ratio)
                        image.width = image.width * ratio
                        image.height = image.height * ratio
                    } else if (image.height < image.parentElement.offsetHeight) {
                        // heighten the image
                        let ratio = image.parentElement.offsetHeight / image.height
                        console.log("ratio height: " + ratio)
                        image.width = image.width * ratio
                        image.height = image.height * ratio
                    }
                } else {
                    if (image.width > image.parentElement.offsetWidth) {
                        // widen the image
                        let ratio = image.parentElement.offsetWidth / image.width
                        console.log("ratio width: " + ratio)
                        image.width = image.width * ratio
                        image.height = image.height * ratio
                    } else if (image.height > image.parentElement.offsetHeight) {
                        // heighten the image
                        let ratio = image.parentElement.offsetHeight / image.height
                        console.log("ratio height: " + ratio)
                        image.width = image.width * ratio
                        image.height = image.height * ratio
                    }
                }*/
                // center the image
                image.style.top = (- (image.height - image.parentElement.offsetHeight) / 2) + "px"
                image.style.left = (- (image.width - image.parentElement.offsetWidth) / 2) + "px"
            }
            //image.style.width = "100%"
            image.style.height = '100%'
            /*image.style.marginLeft = 'auto'
            image.style.marginRight = 'auto'
            image.style.marginTop = 'auto'
            image.style.marginBottom = 'auto'*/
            //image.style.left = '-50%'
            image.style.position = "relative"
            imageEnclosure.appendChild(image)

            if (book.position) {
                let progressEnclosure = document.createElement("span")
                progressEnclosure.style.position = "relative"
                progressEnclosure.style.width = "80%"
                progressEnclosure.style.height = "5%"
                progressEnclosure.style.top = "-10%"
                progressEnclosure.style.left = "10%"
                progressEnclosure.style.display = "inline-block"
                progressEnclosure.style.backgroundColor = "white"
                progressEnclosure.style.border = "1px solid black"

                let progress = document.createElement("span")
                progress.style.position = "absolute"
                progress.style.display = "inline-block"
                /*progress.style.margin = "10%"*/
                progress.style.height = "80%"
                progress.style.width = (99 * (book.position / book.size)) + "%"
                progress.style.top = "10%"
                progress.style.left = "1%"
                progress.style.backgroundColor = "black"

                progressEnclosure.appendChild(progress)
                
                imageEnclosure.appendChild(progressEnclosure)
            }

            itemLink.appendChild(imageEnclosure)

            let title = document.createElement("span")
            title.innerHTML = book.title
            itemLink.appendChild(title)
            item.appendChild(itemLink)
            return item
        }
        function getBookList(books) {
            let list = document.createElement('ul')
            list.style.padding = '0'
            list.style.listStyleType = 'none'
            list.style.display = 'grid'
            list.style.gridTemplateColumns = '30vw 30vw 30vw'
            list.style.columnGap = '2.5vw'
            list.style.rowGap = '2.5vw'

            for (let i = 0; i < books.length; i++) {
                let item = getBookItem(books[i])
                list.appendChild(item)
            }

            return list
        }
        function createBookCover(title, width, height, element) {
            let margin = width / 10
            let words = title.split(/\s/g)
            console.log(words)
            let rows = []
            let row = ""
            let words_on_row = 3
            let longestRow = 0
            for (let i = 0; i < words.length; i++) {
                if (i % words_on_row == 0) {
                    if (row.length > 0) {
                        rows.push(row)
                        if (row.length > rows[longestRow].length) longestRow = rows.length - 1
                    }
                    row = words[i]
                } else {
                    row += " " + words[i]
                }
            }
            if (rows.length > 0) {
                rows.push(row)
                if (row.length > rows[longestRow].length) longestRow = rows.length - 1
            }
            console.log(rows)
            console.log(longestRow)
            

            const canvas = document.createElement('canvas')
            canvas.width = width
            canvas.height = height
            const context = canvas.getContext('2d')
            context.fillStyle = "#FE0000"
            context.fillRect(0, 0, width, height)
            context.fillStyle = "#FFFFFF"
            context.textAlign = "center"

            // find correct font size
            let fontSize = width/rows[longestRow].length * 3
            context.font = fontSize + "px serif"
            while (context.measureText(rows[longestRow]).width > width - margin) {
                fontSize -= 1
                context.font = fontSize + "px serif"
            }

            let rowHeight = 0
            //let totalHeight = 0
            for (let i = 0; i < rows.length; i++) {
                let tm = context.measureText(rows[i])
                console.log(tm)
                let height = tm.actualBoundingBoxAscent + tm.actualBoundingBoxDescent
                //totalHeight += height
                if (height > rowHeight) rowHeight = height
            }
            console.log(rowHeight)
            let totalHeight = rowHeight * rows.length

            for (let i = 0; i < rows.length; i++) {
                let h = (height/2) - (totalHeight/2) + i * rowHeight + rowHeight / 2
                context.fillText(rows[i], width/2, h)
            }
            
            let base64 = canvas.toDataURL() 
            
            if (element) {
                let img = document.createElement('img')
                img.src = base64
                element.appendChild(img)
            }

            return base64
        }
        window.onload = function() {
            fetch("/books")
            .then(response => {
                return response.json()
            })
            .then((books) => {
                console.log(books)
                let bookList = document.getElementById("bookList")
                bookList.innerHTML = ""
                bookList.appendChild(getBookList(books))
            })
            fetch("search")
            .then(response => {
                console.log(response)
                return response.json()
            })
            .then(searchResult => {
                let searchList = document.getElementById("searchList")
                searchList.innerHTML = ""
                searchList.appendChild(getBookList(searchResult))
            })
            //createBookCover("A book about political science and all other stupid shit that has a ridiculously long title", 300, 500, document.getElementById("testCover"))
        }
    </script>
    <style>
        body {
            font-size: 1.5rem;
        }
    </style>
</head>
<body>
    <h1>Chronic Reader Client</h1>
    <div id="testCover"></div>
    <div id="bookList"></div>
    <form action="upload" enctype="multipart/form-data" method="post">
        <label for="myFile">Upload Your File</label>
        <input id="myFile" accept=".epub,.cbz,.cbr" name="filename" type="file" />
        <button name="submit" type="submit">Upload File</button>
    </form>
    <form action="login" method="post">
        <label for="server">Server</label><input name="server" type="text" />
        <label for="username">Username</label><input name="username" type="text" />
        <label for="password"></label><input name="password" type="password" />
        <button name="submit" type="submit">Login</button>
    </form>
    <div id="searchList"></div>
</body>
</html>